= plain-common-lisp
:toc:
:toclevels: 4

:url-cl:           https://common-lisp.net
:url-releases:     https://github.com/pascalcombier/plain-common-lisp/releases
:url-plainstarter: https://github.com/pascalcombier/plain-starter
:url-quicklisp:    http://blog.quicklisp.org
:url-asdf:         https://asdf.common-lisp.dev
:url-defsystem:    https://asdf.common-lisp.dev/asdf.html=The-defsystem-form
:url-ql-releases:  https://www.quicklisp.org/beta/releases.html
:url-zach:         https://www.xach.com
:url-slime:        https://slime.common-lisp.dev/doc/html
:url-emacs:        https://www.gnu.org/software/emacs
:url-fare-1:       http://fare.tunes.org/files/asdf3/asdf3-2014.html
:url-fare-2:       http://fare.tunes.org/files/asdf3/scripting-slides.pdf
:url-sbcl:         http://www.sbcl.org
:url-save-and-die: http://www.sbcl.org/manual/=Function-sb_002dext-save_002dlisp_002dand_002ddie)
:url-asdf-tuto:    https://fare.livejournal.com/176185.html
:url-asdf-10:      http://fare.tunes.org/files/asdf3/asdf3-2014.pdf
:url-iup:          http://webserver2.tecgraf.puc-rio.br/iup/
:url-uiop:         https://asdf.common-lisp.dev/uiop.pdf
:url-zstd:         https://github.com/facebook/zstd

== Document versioning

[cols="2,2,3,5",options="header"]
|==========================================================
| Version | Date       | Author         | Comment
| v0.1    | 2022-07-17 | Pascal COMBIER | Initial release
| v0.2    | 2022-07-23 | Pascal COMBIER | Add SLIME chapter
|==========================================================

== Introduction

plain-common-lisp is a lightweight framework created to make it easier for
software developers to develop and distribute {url-cl}[Common Lisp]’s
applications on Microsoft Windows:

1. Download the {url-releases}[latest release] of plain-common-lisp
2. Extract the archive in your workspace
3. Done: you have a decent <<bookmark-quicklisp,Quicklisp-enabled>> and <<bookmark-slime,SLIME-compatible>> Common Lisp's distribution on Windows!

image::docs/images/readme/03-workspace-directory-highlight.png[screenshot]
image::docs/images/readme/06-repl.png[screenshot]

At this point, the Common Lisp's REPL is ready and the user can already work
with all {url-ql-releases}[the third-party libraries] available from Quicklisp!
This makes Common Lisp a good candidate for writing {url-fare-1}[small programs]
and {url-fare-2}[utilities]. Thousands of Common Lisp's libraries are available,
to give an example, one can install a HTTP library and start to use it
immediately:

image::docs/images/readme/07-winhttp-highlight.png[screenshot]

The changes are persistent: the installed libraries will be available after a
restart.

image::docs/images/readme/08-next-startup-highlight.png[screenshot]

plain-common-lisp is basically a ready-to-use distribution of {url-sbcl}[SBCL]
and {url-quicklisp}[Quicklisp]. The distribution is small and only contains a few
files.

```
plain-common-lisp
│   plain-common-lisp.exe
│   README.md
├───applications
├───cache
├───configs
│       plain-common-lisp.cfg
├───sources
│   └───lisp
│           pcl-loader.lisp
└───third-party
    ├───binaries
    │   │   sbcl.core
    │   │   sbcl.exe
    │   └───contrib (SBCL's fasl files)
    └───quicklisp
            quicklisp.lisp
```

To keep the plain-common-lisp archive small, Quicklisp is not included. For that
reason, the first startup might be a little bit slow because plain-common-lisp
will:

* Download and install the last version of Quicklisp from the Internet

* Compile the Lisp code and store the compilation results into the "cache"
  directory

The following executions should be much faster.

image::docs/images/readme/01-workspace-directory.png[screenshot]
image::docs/images/readme/02-workspace-cache-empty.png[screenshot]
image::docs/images/readme/03-workspace-directory-highlight.png[screenshot]
image::docs/images/readme/04-first-execution.png[screenshot]
image::docs/images/readme/05-workspace-cache-populated.png[screenshot]
image::docs/images/readme/06-repl.png[screenshot]

== Examples

This chapter will describe how to use the plain-common-lisp project to develop
and distribute several applications. These examples can be downloaded from
{url-releases}[the releases area] of plain-common-lisp.

=== Console Hello World! 

Let's write a _Hello-World_ application with plain-common-lisp. To do that, we
just need to extract the last release of plain-common-lisp project:

image::docs/images/helloworld/00-plain-common-lisp-directory.png[screenshot]

Initially, the "applications" directory is empty:

image::docs/images/helloworld/01-applications-directory-empty.png[screenshot]

We first need to create a directory "hello-world" and follow plain-common-lisp
directory structure.

image::docs/images/helloworld/01-applications-directory.png[screenshot]
image::docs/images/helloworld/02-applications-directory-helloworld.png[screenshot]

The "sources" directory of the application "hello-world" contains the source
code. Nothing specific to plain-common-lisp here, this structure is common to
most Common Lisp's projects.

image::docs/images/helloworld/03-applications-directory-helloworld-sources.png[screenshot]

The file "hello-world.asd" defines the way to compile the source code of the
application. The format is {url-defsystem}[documented in the ASDF project].

[source,lisp]
----
;;; +----------+-------------------------------------------------------+
;;; | Info     | Value                                                 |
;;; +----------+-------------------------------------------------------+
;;; | Filename | hello-world.asd                                       |
;;; | Project  | plain-command-lisp-examples                           |
;;; +------------------------------------------------------------------+

(asdf:defsystem #:hello-world
    :description "Hello world for plain-common-lisp"
    :author      "Pascal COMBIER"
    :license     "BSD"
    :components
     ((:file "package")
      (:file "hello-world" :depends-on ("package"))))
----

The "package.lisp" file describe the package "hello-world" which exports the "main" function:

[source,lisp]
----
;;; +----------+-------------------------------------------------------+
;;; | Info     | Value                                                 |
;;; +----------+-------------------------------------------------------+
;;; | Filename | package.lisp                                          |
;;; | Project  | plain-command-lisp-examples                           |
;;; +----------+-------------------------------------------------------+

(defpackage #:hello-world
  (:use
   #:common-lisp)
  (:export #:main))
----

The file "hello-world.lisp" implements the "main" function.

[source,lisp]
----
;;; +----------+-------------------------------------------------------+
;;; | Info     | Value                                                 |
;;; +----------+-------------------------------------------------------+
;;; | Filename | hello-world.lisp                                      |
;;; | Project  | plain-command-lisp-examples                           |
;;; +----------+-------------------------------------------------------+

(in-package :hello-world)

;;--------------------------------------------------------------------;;
;; IMPLEMENTATION                                                     ;;
;;--------------------------------------------------------------------;;

(defun main ()
  (format t "Hello World!~%"))
----

It's trivial to test such application because all the applications in the
"applications" directory are automatically registered to ASDF at
plain-common-lisp's startup:

image::docs/images/helloworld/05-application-hello-world-test-highlight.png[screenshot]

To distribute this application, one way could be to distribute it with its
source code. An easy approach would be to use the
{url-plainstarter}[plain-starter] project. To do that, simply _duplicate_
"plain-common-lisp.exe" into "hello-world.exe".

image::docs/images/helloworld/06-directory-with-helloworld-exe-highlight.png[screenshot]

Then, it's also needed to duplicate "configs/plain-common-lisp.cfg" into
"configs/hello-world.cfg".

image::docs/images/helloworld/07-directory-config-helloworld.png[screenshot]

Then we would need to add a special file in the applications directory:

image::docs/images/helloworld/08-directory-main.png[screenshot]

.main.lisp
[source,lisp]
----
(asdf:load-system "hello-world")
(hello-world:main)
----

Obviously, launching "hello-world.exe" will start our application:

image::docs/images/helloworld/08-directory-with-helloworld-exe.png[screenshot]
image::docs/images/helloworld/09-hello-world-result-highlight.png[screenshot]

The last step before creating a ZIP file and distribute this application would
be to delete the unnecessary files: "plain-common-lisp.exe",
"configs/plain-common-lisp.cfg" and remove all the files from the cache
directory.

image::docs/images/helloworld/10-final-directory.png[screenshot]

Another way would be to distribute this application as a binary file, without
any source code. This can be achieved by using the
{url-save-and-die}[save-lisp-and-die] function from SBCL.

[source,lisp]
----
(sb-ext:save-lisp-and-die "hello-world-prod.exe" :toplevel #'hello-world:main :executable t :compression t)
----

Note that the "compression" flag is not mandatory here. It's a SBCL feature
which is not always enabled on the official SBCL binaries for Windows. The SBCL
binaries of plain-common-lisp's always have this feature activated, allowing to
trade a little bit of startup time to get a smaller binary size. Note that since
SBCL 2.2.6, {url-zstd}[the zstd from Facebook] is used for the compression. A
compressed hello-world will typically take around 10.5 MiB and the startup time
be negligible.

image::docs/images/helloworld/11-save-lisp-and-die-highlight.png[screenshot]
image::docs/images/helloworld/12-final-directory-with-exe-highlight.png[screenshot]
image::docs/images/helloworld/13-terminal-execution-highlight.png[screenshot]

=== The applications directory

The applications directory contains directories. Each of these directory is
composed of:

* One or several ASDF systems available in the "sources" directory. A ASDF
  system is a directory containing a 'asd' file and the associated Lisp files.

* Third-party Lisp code can be stored in "third-party/sources". This is rarely
  needed but can be useful if there is some Lisp dependancies not available in
  Quicklisp. In such case, it's simply needed to copy the ASDF system directory
  in this "third-party/sources/my-dependancy/" directory. Obviously, this
  directory will also need to contain the ASDF system with the 'asd' file.

* System-specifc binaries can be stored in the "third-party/bin" directory. This
  is required if the system is using DLL files.

== SLIME configuration

<<bookmark-slime,SLIME>> is a fantastic package working on {url-emacs}[GNU
Emacs]. It allows to develop Common Lisp's applications in an interactive
way. This package is compatible with plain-common-lisp.

=== Install SLIME on GNU Emacs

This chapter is based on a fresh installation of the vanilla GNU Emacs. The
default package repository contains an old SLIME version which is not working
properly. The third-party repository MELPA contains a good version. The first
step is to add this MELPA repository to GNU Emacs.

image::docs/images/slime-emacs-install-slime/01-emacs-starts.png[screenshot]

Press `Alt-x` and then enter the command `customize-variable`.

image::docs/images/slime-emacs-install-slime/02-customize-variable.png[screenshot]

Input `package-archives`.

image::docs/images/slime-emacs-install-slime/03-customize-variable-package-archives.png[screenshot]

Click on `INS` to insert a new repository:

- Name: MELPA
- URL: https://melpa.org/packages/

image::docs/images/slime-emacs-install-slime/04-add-melpa.png[screenshot]

Click on "STATE" and then "Save for Future Sessions".

image::docs/images/slime-emacs-install-slime/05-save-package-archives.png[screenshot]

Restart GNU Emacs. This is not techically required but slighly simplier to
document.

image::docs/images/slime-emacs-install-slime/06-emacs-starts.png[screenshot]

Press `Alt-x` and then enter the command `list-packages`. Wait a few seconds for
the package list to be downloaded.

image::docs/images/slime-emacs-install-slime/07-emacs-list-packages.png[screenshot]

Find the MELPA version of "SLIME" and press `i` the mark the software for installation.

image::docs/images/slime-emacs-install-slime/08-mark-slime-melpa.png[screenshot]

Press `x` to start the installation.

image::docs/images/slime-emacs-install-slime/09-confirm-install.png[screenshot]

That's done, SLIME is installed on GNU Emacs.

image::docs/images/slime-emacs-install-slime/10-slime-install-done.png[screenshot]

=== Install SWANK in plain-common-lisp

This chapter is based on a fresh installation of plain-common-lisp.

image::docs/images/slime-pcl-install-swank/01-pcl-fresh-start.png[screenshot]

Install SWANK from Quicklisp with the command `(ql:quickload "swank")`.

image::docs/images/slime-pcl-install-swank/02-pcl-quickload-swank.png[screenshot]

One can start a SWANK server with the function `(swank:create-server)` which
will create a local server. By default, this server will listen on the port
4005. This function will need to be called each time the application is
executed.

image::docs/images/slime-pcl-install-swank/03-pcl-swank-create-server.png[screenshot]

Create a new Lisp file in the "applications" directory.

image::docs/images/slime-pcl-install-swank/04-pcl-create-lisp-file.png[screenshot]

For example, one can write a hello-world function.

image::docs/images/slime-pcl-install-swank/05-create-hello-word.png[screenshot]

At this stage, let's try to make Emacs connect to the plain-common-lisp
process. Press `Alt-x` and type the command `slime-connect`.

image::docs/images/slime-pcl-install-swank/06-slime-connect.png[screenshot]

When prompted about which host to use, just validate: the default host
`localhost` is perfectly fine.

image::docs/images/slime-pcl-install-swank/07-slime-connect-localhost.png[screenshot]

When prompted about which port to use, just validate: the default port
`4005` is perfectly fine.

image::docs/images/slime-pcl-install-swank/08-slime-connect-port.png[screenshot]

That's it, SLIME is started and connected to the plain-common-lisp process.

image::docs/images/slime-pcl-install-swank/09-slime-started.png[screenshot]

To compile the `hello-world` function and send it to plain-common-lisp, it is
simply needed to type `Ctrl-c Ctrl-c`. The result of the compilation will appear
in the terminal below the source code. One can directly test the hello-world
function by jumping in the REPL and typing the Common Lisp code `(hello-world)`.

This is exactly why it is named _interactive_. The programmer write a function
in its source code and test it immediately. If the function is working, the
developer can save the file and then write a new function. The development of
the program is done step-by-step in a incremental way.

image::docs/images/slime-pcl-install-swank/10-slime-interaction.png[screenshot]

In most of Common Lisp's programs there are different packages. By default,
SLIME starts in the standard package `common-lisp-user` also named
`CL-USER`. All the functions will be created in this package. If one want to
switch to another package, he can:

- Press `Alt-x` and then type the command `slime-repl-set-package`
- Use the shortcut `Ctrl-c` then `Alt-p`

The package names can be automatically completed when pressing the `TAB` key.

In the example below, we have created a package "hello" exporting the "main"
function. Then we asked SLIME to jump inside this package. At this point, we
implemented the "main" function and tested it.

image::docs/images/slime-pcl-install-swank/11-slime-packages.png[screenshot]

=== Make the SLIME configuration persistent

A full example is available and can be downloaded from {url-releases}[the
releases area] of plain-common-lisp. We can make the assumption that the SWANK
server might not be needed when delivering the application to the users. So it
could be reasonable to consider 2 environments:

- Development environment, starting SWANK server automatically
- Production environment, without any SWANK server

Creating a new environment simply means duplicating 2 files. Duplicate
"plain-common-lisp.exe" into "plain-common-lisp-dev.exe". Duplicate
"configs/plain-common-lisp.cfg" into "configs/plain-common-lisp-dev.cfg".

image::docs/images/slime-persistent/01-dev-environment.png[screenshot]
image::docs/images/slime-persistent/02-dev-config.png[screenshot]

Then one simply need to write the "plain-common-lisp-dev" application startup
file named "plain-common-lisp-dev.lisp".

image::docs/images/slime-persistent/03-applications.png[screenshot]

.plain-common-lisp-dev.lisp
[source,lisp]
----
(asdf:load-system "swank")
(swank:create-server)
----

When the program "plain-common-lisp-dev.exe" will be executed, it will try to
load and execute the file "applications\plain-common-lisp-dev.lisp". This
startup file will load SWANK and create a server.

After that, we can just run the application "plain-common-lisp-dev.exe" and
connect with SLIME from GNU Emacs. The SWANK server is started automatically.

image::docs/images/slime-persistent/04-slime.png[screenshot]

=== Known issues

There is a second way to start SLIME from GNU Emacs from an executable
file. This method is unfortunately not currently supported. The reason is
technical, the SWANK package from Quicklisp implements its own FASL binaries
relocation scheme. It does it in a way which is not compatible with
plain-common-lisp.

image::docs/images/slime-known-issues.png[screenshot]

The FASL files from plain-common-lisp and SWANK being located in different
directories, plain-common-lisp startup meets an error. If one successfuly modify
SWANK so that he don't implement any custom FASL redirection, this issue would
be solved.

== External references

* [[bookmark-quicklisp]]{url-quicklisp}[Quicklisp] is the fantastic library
manager for Common Lisp developped by {url-zach}[Zach Beane]. Note that
Quicklisp is unaffiliated to plain-common-lisp's project.

* [[bookmark-slime]]{url-slime}[SLIME] is a powerful mode for {url-emacs}[GNU
Emacs] allowing to write programs in an interactive and incremental way.

* {url-asdf}[ASDF] is the de-facto standard tool to build Common Lisp
software. It has been maintained {url-asdf-10}[over 10 years] and
    {url-asdf-tuto}[greatly documented] by the outstanding François-René Rideau.
